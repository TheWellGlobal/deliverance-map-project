<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Interactive Map Directory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { 
        margin: 0; 
        font-family: Georgia, 'Times New Roman', Times;
    }
    #map { height: 90vh; }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
      background: #08387a;
      box-shadow: 0 2px 6px #08387a;
      z-index: 1000;
      position: relative;
    }
    .custom-popup .leaflet-popup-content-wrapper {
      background-color: #08387a; 
      font-family: 'Times New Roman', Times, serif;
      color: #fff;
      border-radius: 10px;
      padding: 12px;
    }
    .custom-popup .leaflet-popup-tip {
      background: #1e1e2f;
      font-family: 'Times New Roman', Times, serif;
    }

    .filters select, .filters input, .filters button {
      padding: 6px 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-family: 'Times New Roman', Times, serif;
    }

    #cityDropdown:disabled {
      background-color: #ffffff;
      color: #000000;             
      cursor: not-allowed;      
      opacity: .8;
    }

    #markerModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #modalContent {
      background-color: #08387a;
      color: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 50%;
      height: 50%;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
      font-family: 'Times New Roman', Times, serif;
      justify-content: center;
      display: flex;
      flex-wrap: wrap;
      text-align: center;
      align-items: center;
      line-height: 1.3;
    }

    #closeModal {
      position: absolute;
      top: 10px;
      right: 15px;
      background: transparent;
      color: #fff;
      font-size: 24px;
      border: none;
      cursor: pointer;
    }

    .tag-container {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;   
      justify-content: center;
      line-height: 1.3; 
    }

    .tag {
      padding: 5px 10px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: bold;
      color: white;
      display: inline-flex;
      justify-content: center;
      white-space: nowrap;
    }

    .tag-color-0 { background-color: #03045E; }
    .tag-color-1 { background-color: #023E8A; }
    .tag-color-2 { background-color: #0096C7; }
    .tag-color-3 { background-color: #CAF0F8; color:black; }
    .tag-color-4 { background-color: #00B4D8; }
    .tag-color-5 { background-color: #90E0EF; color:black; }
  </style>
</head>

<body>
  <div class="filters">
    <input id="searchBox" placeholder="Search locations..." />
    <select id="stateDropdown"><option value="">All States</option></select>
    <select id="cityDropdown" disabled><option value="">All Cities</option></select>
    <select id="specialtyDropdown"><option value="">All Experiences</option></select>
    <button id="applyFilters">Apply Filters</button>
    <button id="clearFilters">Clear Filters</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>

    // -------------------------------------------------
    // ADDED: Specialty â†’ Color map
    // -------------------------------------------------
    const specialtyColorMap = {
      "Bloodline Deliverance": "#03045E",
      "New Age": "#023E8A",
      "SRA": "#0096C7",
      "Freemasonry": "#CAF0F8",
      "Soul Fracture": "#00B4D8",
      "Emotional Healing": "#90E0EF"
    };

    function luminance(hex) {
      hex = hex.replace('#','');
      const r = parseInt(hex.substring(0,2),16) / 255;
      const g = parseInt(hex.substring(2,4),16) / 255;
      const b = parseInt(hex.substring(4,6),16) / 255;
      const a = [r,g,b].map(c => (c <= 0.03928) ? c/12.92 : Math.pow((c+0.055)/1.055, 2.4));
      return 0.2126*a[0] + 0.7152*a[1] + 0.0722*a[2];
    }
    function bestTextColor(hex) {
      return luminance(hex) > 0.5 ? '#000' : '#fff';
    }
    // -------------------------------------------------
    // END ADDED
    // -------------------------------------------------


    const map = L.map('map').setView([39.5, -98.35], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OSM &copy; CARTO',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    let allMarkers = [];
    let locations = [];

    const searchBox = document.getElementById('searchBox');
    const stateDropdown = document.getElementById('stateDropdown');
    const cityDropdown = document.getElementById('cityDropdown');
    const specialtyDropdown = document.getElementById('specialtyDropdown');

    fetch('locations.json')
      .then(r => r.json())
      .then(data => {
        locations = data;

        locations.forEach(loc => {
          let marker = L.marker([loc.lat, loc.lng]).addTo(map);

          let modal = document.getElementById('markerModal');
          let modalBody = document.getElementById('modalBody');
          let closeModal = document.getElementById('closeModal');

          marker.on('click', () => {
            let content = `
              <h2>${loc.name}</h2>
              <p>${loc.address || ''}<br>${loc.city}, ${loc.state}</p>
            `;

            if (loc.phone) content += `<p>${loc.phone}</p>`;
            if (loc.site) {
              content += `<p><a href="${loc.site}" target="_blank" style="color:#fff;">Visit Website</a></p>`;
            } else if (loc.email) {
              content += `<p>${loc.email}</p>`;
            }

            if (Array.isArray(loc.specialty)) {
              content += `<div class="tag-container">`;
              loc.specialty.forEach((tag, i) => {
                const colorIndex = i % 6;
                content += `<span class="tag tag-color-${colorIndex}">${tag}</span>`;
              });
              content += `</div>`;
            }

            modalBody.innerHTML = content;
            modal.style.display = 'flex';
          });

          allMarkers.push({ ...loc, marker });

          closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
          });
        });

        populateFilters();
        filterMarkers();
      });

    searchBox.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        filterMarkers();
      }
    });

    const applyButton = document.getElementById('applyFilters');

    function populateFilters() {
      const states = [...new Set(locations.map(l => l.state))].sort();
      states.forEach(s => stateDropdown.appendChild(new Option(s, s)));

      const specialties = [...new Set(locations.flatMap(l => l.specialty))].sort();
      specialties.forEach(spec => specialtyDropdown.appendChild(new Option(spec, spec)));

      // ADDED: apply initial color

      specialtyDropdown.addEventListener('change', () => {
        applySpecialtyColorByName(specialtyDropdown.value);
      });

      stateDropdown.addEventListener('change', populateCities);
      applyButton.addEventListener('click', filterMarkers);
    }

    function populateCities() {
      const selectedState = stateDropdown.value;
      let filteredCities = locations
        .filter(l => !selectedState || l.state === selectedState)
        .map(l => l.city);

      filteredCities = [...new Set(filteredCities)].sort();

      cityDropdown.innerHTML = '<option value="">All Cities</option>';
      filteredCities.forEach(city => cityDropdown.appendChild(new Option(city, city)));

      cityDropdown.disabled = !selectedState || filteredCities.length === 0;
    }

    function filterMarkers() {
      const searchTerms = searchBox.value.toLowerCase().split(' ').filter(Boolean);
      const stateVal = stateDropdown.value;
      const cityVal = cityDropdown.value;
      const specialtyVal = specialtyDropdown.value;

      let visibleMarkers = [];

      allMarkers.forEach(item => {
        const specialties = Array.isArray(item.specialty) ? item.specialty : [];
        const searchableText = [
          item.name,
          item.address,
          specialties.join(' '),
          item.city,
          item.state,
          item.stateAbbr
        ].join(' ').toLowerCase();

        const matchesText = searchTerms.every(t => searchableText.includes(t));
        const matchesState = !stateVal || item.state === stateVal;
        const matchesCity = !cityVal || item.city === cityVal;
        const matchesSpecialty = !specialtyVal || specialties.map(s => s.toLowerCase()).includes(specialtyVal.toLowerCase());

        if (matchesText && matchesState && matchesCity && matchesSpecialty) {
          item.marker.addTo(map);
          visibleMarkers.push(item.marker);
        } else {
          map.removeLayer(item.marker);
        }
      });

      zoomToFilteredMarkers(visibleMarkers);
    }

    function zoomToFilteredMarkers(markers) {
      if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    const clearButton = document.getElementById('clearFilters');
    clearButton.addEventListener('click', () => {
      searchBox.value = '';
      stateDropdown.value = '';
      cityDropdown.value = '';
      cityDropdown.disabled = true;
      specialtyDropdown.value = '';

      populateCities();
      map.setView([39.5, -98.35], 4);

      allMarkers.forEach(item => item.marker.addTo(map));
      filterMarkers();
      populateFilters();
    });

  </script>

  <div id="markerModal" style="display:none;">
    <div id="modalContent">
      <button id="closeModal">&times;</button>
      <div id="modalBody"></div>
    </div>
  </div>
</body>
</html>
